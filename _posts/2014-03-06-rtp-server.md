---
layout: post
title:  "关于RTP传输视频流的琐记"
date:   2014-03-06 21:50:43
categories: RTP network
---

## 为何NAT里面的主机可以访问NAT外的WEB服务器，但不能获取RTSP流媒体服务器码流？

**原因**：

对于 HTTP 这样的协议，客户端与 WEB 服务器建立 socket 连接， 是由 WEB 服务器绑定一个固定的 TCP 端口，在这个端口监听。 位于 NAT 后面的客户端随机选择一个 TCP 端口 `connect(2)` WEB SERVER。

而对于 RTSP 流媒体服务器，采用 RTP 封装多媒体荷载的话，一般的实现是位于客户端这边的播放器看 UDP 5000这个端口(也可定义为其他端口, 不过主流的播放器大多是这个端口)是否占用， 未占用绑定, 然后请求流媒体码流前通过 RTSP 数据包交互告诉服务器播放器这边接收 RTP 数据包的端口， 流媒体服务器随机选择一个端口发送 RTP 包，并把即将启动的会话信息通过 SDP 格式以 RTSP 封装通知播放器。因此，对于 RTP 通信来说，
真正的服务端是在播放器这边，被动地接收 RTSP 服务器那边发送过来的 RTP 码流。

一般类型的 NAT 允许一个数据包通过的条件是：

1. 如果这个数据包是从 NAT 里面的设备向外网发送的， 允许通过。NAT 设备会查看这个数据包的源ip地址与端口及目的地址与端口信息，如果没有建立过映射关系就新建一个NAT映射关系: 把源ip与端口转换为NAT地址与一个新分配的端口(根据NAT设备类型的不同，映射关系不同，完全锥型是只根据源IP与端口， 地址受限锥型是增加目的地址信息， 而端口受限类型NAT又增加目的端口信息，对称型NAT则源ip端口与目的ip端口只要一项改变，就新增一个映射)。
2. 如果这个数据包是从 NAT 外面发送给里面的，看这个数据包的信息能否在NAT映射表里找到对应的映射，找到则运行通过，NAT 将它发给对应的设备。找不到则不能通过。 

因此，位于NAT里面的主机可以这样正常的访问外网的HTTP web服务器：发起HTTP请求时， NAT 会为这个会话建立一个映射关系，这样 WEB 服务器回应的包正好匹配这个映射，于是可以被客户端浏览器接收。

但是NAT里面的主机要请求流媒体就不行了：对于 RTSP 来说， 和 HTTP 一样可以正常通信， 关键是对于 RTP 包， 服务端是在 NAT 里面的播放器的，即使 RTSP 知道NAT里面播放器主机的地址以及NAT地址， RTP 包到达 NAT 时，属于上述的2的情况，由于之前没有建立映射关系，这个包将被 NAT 丢弃。

有的流媒体服务器会使用 HTTP 来封装流媒体，可以获取较好的穿透性， 不过需要实现自己的播放器才能解码了。


## RTP 丢包的一个原因

(待续)

